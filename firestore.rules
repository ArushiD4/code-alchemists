rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helpers ───────────────────────────────────────────────────────────
    function isAuth() {
      return request.auth != null;
    }

    function role() {
      return request.auth.token.role;
    }

    function isRole(r) {
      return isAuth() && role() == r;
    }

    function isAdmin() {
      return isAuth() && role() == 'admin';
    }

    // ─── PATIENTS ───────────────────────────────────────────────────────────
    match /patients/{patientId} {
      allow read:   if isAuth() && role() in ['paramedic', 'driver', 'admin'];
      allow create: if isRole('paramedic');
      allow update: if isAuth() && (
        isAdmin() ||
        // Paramedic can update their own cases
        (isRole('paramedic') && resource.data.createdBy == request.auth.uid) ||
        // Driver can only update status + assignedDriverId + updatedAt
        (isRole('driver') &&
          request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasOnly(['assignedDriverId', 'status', 'updatedAt']))
      );
      allow delete: if isAdmin();
    }

    // ─── IMAGES ─────────────────────────────────────────────────────────────
    match /images/{imageId} {
      allow read:   if isAuth() && role() in ['paramedic', 'driver', 'admin'];
      allow create: if isRole('paramedic');
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ─── QUEUES ─────────────────────────────────────────────────────────────
    // Written only by Cloud Functions (Admin SDK bypasses rules)
    match /queues/{queueId} {
      allow read:  if isAuth() && role() in ['driver', 'admin'];
      allow write: if isAdmin();
    }

    // ─── HOSPITALS ──────────────────────────────────────────────────────────
    match /hospitals/{hospitalId} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }

    // ─── EVENTS (audit trail) ────────────────────────────────────────────────
    // Append-only via Cloud Functions Admin SDK; read for admin only
    match /events/{eventId} {
      allow read:  if isAdmin();
      allow write: if false;
    }
  }
}
